using UnityEngine;
using UnityEngine.InputSystem;
using UnityEngine.Tilemaps;
using System.Collections;
using Kinnly;

public class PlayerMove : MonoBehaviour
{
    public Vector2 inputVec;
    public float speed = 5f;
    private Rigidbody2D rigid;
    private SpriteRenderer spriteRenderer;
    public Tilemap farmTilemap;
    public Tilemap waterTilemap;
    public landtiles landTileManager;
    private string currentEquipment = "";

    public bool event_time;
    Animator anim;
    private GameObject collidedObject = null;

    [SerializeField] private Inventory inventory;
   
    [SerializeField] private ObjectSpawner objectSpawner; // ë“œë˜ê·¸ ì—°ê²° í•„ìš”(2025-07-27)

    public int selectedQuickSlotIndex = 0; // í€µìŠ¬ë¡¯ ì¶”ê°€ë³€ìˆ˜ 260221

    private void Awake()
    {
        rigid = GetComponent<Rigidbody2D>();
        spriteRenderer = GetComponent<SpriteRenderer>();
        anim = GetComponent<Animator>();
        event_time = false;
    }

    // â˜… ì¸ë²¤í† ë¦¬ ê°±ì‹  ì´ë²¤íŠ¸ êµ¬ë… (ì•„ì´í…œì„ ì˜®ê¸°ê±°ë‚˜ ì“°ë©´ ì†ì— ë“  ê²ƒë„ ê°±ì‹ )
    private void Start()
    {
        if (inventory != null)
        {
            inventory.onItemChangedCallback += UpdateCurrentEquipment;
        }
    }

    private void OnDestroy()
    {
        if (inventory != null)
        {
            inventory.onItemChangedCallback -= UpdateCurrentEquipment;
        }
    }
    // Update()ì—ì„œ í´ë¦­ ê°ì§€(2025.06.28 ìˆ˜ì •)
    private void Update() 
    {
        //Quickslot();
        //// ë§ˆìš°ìŠ¤ í´ë¦­ ì‹œ ë†ì‚¬ í–‰ë™ ì²˜ë¦¬
        //if (Mouse.current.leftButton.wasPressedThisFrame && !event_time)
        //{
        //    OnMouseClick();
        //}
        //if (Keyboard.current.fKey.wasPressedThisFrame)
        //{
        //    TryDestroyNearestSpawnedObject();
        //}

  

    }

    private void LateUpdate()
    {
        anim.SetFloat("Speed", inputVec.magnitude);
        if (inputVec.x != 0)
        {
            spriteRenderer.flipX = inputVec.x < 0;
        }
    }

    private void OnMove(InputValue value)
    {
        inputVec = value.Get<Vector2>();
        if (!event_time)
        {
            anim.SetBool("Fishing", false);
        }
    }

    private void FixedUpdate()
    {
        if (!event_time)
            rigid.linearVelocity = inputVec * speed;
        else
            rigid.linearVelocity = Vector2.zero;
    }
    /*
private void OnMouseClick()
{
    Vector3 mouseWorldPos = Camera.main.ScreenToWorldPoint(Mouse.current.position.ReadValue());
    Vector3Int tilePos = farmTilemap.WorldToCell(mouseWorldPos);
    tilePos.z = 0;

    if (Vector3.Distance(transform.position, farmTilemap.CellToWorld(tilePos)) <= 1.5f)
    {
        HandleFarmAction(tilePos);
    }
}
*/
    // ğŸ”¥ ìˆ˜ì •ëœ ë§ˆìš°ìŠ¤ í´ë¦­ í•¨ìˆ˜
    private void OnMouseClick()
    {
        Vector3 mouseWorldPos = Camera.main.ScreenToWorldPoint(Mouse.current.position.ReadValue());
        mouseWorldPos.z = 0;

        // ë™ë¬¼ ì œê±° ì‹œë„
        if (currentEquipment == "Knife")
        {
            RaycastHit2D hit = Physics2D.Raycast(mouseWorldPos, Vector2.zero, 0f);
            if (hit.collider != null)
            {
                // âŒ ê¸°ì¡´ AnimalAI ë„ì‚´ ë°©ì‹ (ì£¼ì„ ì²˜ë¦¬)
                /*
                AnimalAI animal = hit.collider.GetComponent<AnimalAI>();
                if (animal != null)
                {
                    float dist = Vector2.Distance(transform.position, animal.transform.position);
                    if (dist <= 1.5f)
                    {
                        animal.KillAndDrop(animal.transform.position);
                        Debug.Log("ê°€ì¶•ì´ ë„ì‚´ë˜ì—ˆìŠµë‹ˆë‹¤.");
                        return;
                    }
                }
                */

                // ë³€ê²½: AnimalHealth ê¸°ë°˜ ë„ì‚´ ë°©ì‹
                AnimalHealth health = hit.collider.GetComponent<AnimalHealth>();
                if (health != null)
                {
                    float dist = Vector2.Distance(transform.position, hit.transform.position);
                    if (dist <= 1.5f)
                    {
                        health.Kill(); // ë‚´ë¶€ì—ì„œ Destroy + ë“œë¡­ ì²˜ë¦¬
                        Debug.Log("ê°€ì¶•ì´ ë„ì‚´ë˜ì—ˆìŠµë‹ˆë‹¤.");
                        return;
                    }
                }
            }
        }
        // ê¸°ì¡´ ë†ì‚¬ ì²˜ë¦¬
        Vector3Int tilePos = farmTilemap.WorldToCell(mouseWorldPos);
        tilePos.z = 0;

        if (Vector3.Distance(transform.position, farmTilemap.CellToWorld(tilePos)) <= 1.5f)
        {
            HandleFarmAction(tilePos);
        }
    }
        private void HandleFarmAction(Vector3Int tilePosition)
    {
        if (currentEquipment == "Hoe")
        {
            landTileManager.PlowSoil(tilePosition);
        }
        else if (currentEquipment == "Seeds")
        {
            landTileManager.PlantSeed(tilePosition);
        }
        else if (currentEquipment == "Water")
        {
            landTileManager.WaterTile(tilePosition);
        }
        else if (currentEquipment == "Harvest")
        {
            landTileManager.HarvestCrop(tilePosition);
        }
    }
    
    private void OnInventory()
    {
        if (inventory != null)
        {
            inventory.ToggleUI();
            Debug.Log($"ì¸ë²¤í† ë¦¬ ìƒíƒœ: {inventory.isInventoryOpen}");
        }
    }
    //ìƒˆë¡œìš´ í€µìŠ¬ë¡¯ í•¨ìˆ˜ ì¶”ê°€ 
    //private void Quickslot()
    //{
    //    if (Input.GetKeyDown(KeyCode.Alpha1))
    //    {
    //        currentEquipment = "Hoe";
    //        event_time = false;
    //        Debug.Log("ê´­ì´ ì¥ì°©ë¨ âœ…");
    //    }
    //    else if (Input.GetKeyDown(KeyCode.Alpha2))
    //    {
    //        currentEquipment = "Seeds";
    //        event_time = false;
    //        Debug.Log("ì”¨ì•— ì¥ì°©ë¨ âœ…");
    //    }
    //    else if (Input.GetKeyDown(KeyCode.Alpha3))
    //    {
    //        currentEquipment = "Water";
    //        event_time = false;
    //        Debug.Log("ë¬¼ë¿Œë¦¬ê°œ ì¥ì°©ë¨ âœ…");
    //    }
    //    else if (Input.GetKeyDown(KeyCode.Alpha4))
    //    {
    //        currentEquipment = "Harvest";
    //        event_time = false;
    //        Debug.Log("ìˆ˜í™• ë„êµ¬ ì¥ì°©ë¨ âœ…");
    //    }// ì¶”ê°€: ì¹¼ ì¥ì°©
    //    else if (Input.GetKeyDown(KeyCode.Alpha5))
    //    {
    //        currentEquipment = "Knife";
    //        event_time = false;
    //        Debug.Log("ì¹¼ ì¥ì°©ë¨ ğŸ—¡ï¸");
    //    }
    //}
    private void Quickslot()
    {
        // 1. í‚¤ë³´ë“œ ìˆ«ì í‚¤ ì…ë ¥ ì²˜ë¦¬ ì´í›„ ìŠ¬ë¡¯ ì¡°ì • í•„ìš” 
        if (Input.GetKeyDown(KeyCode.Alpha1)) SelectQuickSlot(0);
        else if (Input.GetKeyDown(KeyCode.Alpha2)) SelectQuickSlot(1);
        else if (Input.GetKeyDown(KeyCode.Alpha3)) SelectQuickSlot(2);
        else if (Input.GetKeyDown(KeyCode.Alpha4)) SelectQuickSlot(3);
        else if (Input.GetKeyDown(KeyCode.Alpha5)) SelectQuickSlot(4);

        // 2. ë§ˆìš°ìŠ¤ íœ  ìŠ¤í¬ë¡¤ë¡œ í€µìŠ¬ë¡¯ ë„˜ê¸°ê¸°
        float scroll = Mouse.current.scroll.ReadValue().y;

        if (scroll > 0) // íœ  ìœ„ë¡œ (ì´ì „ ìŠ¬ë¡¯)
        {
            int newIndex = selectedQuickSlotIndex - 1;
            if (newIndex < 0) newIndex = Inventory.instance.quickSlots.Length - 1;
            SelectQuickSlot(newIndex);
        }
        else if (scroll < 0) // íœ  ì•„ë˜ë¡œ (ë‹¤ìŒ ìŠ¬ë¡¯)
        {
            int newIndex = selectedQuickSlotIndex + 1;
            if (newIndex >= Inventory.instance.quickSlots.Length) newIndex = 0;
            SelectQuickSlot(newIndex);
        }
    }

    // ìŠ¬ë¡¯ ì„ íƒ ì‹œ í˜¸ì¶œë˜ëŠ” ê³µí†µ ë©”ì„œë“œ
    private void SelectQuickSlot(int index)
    {
        if (Inventory.instance == null || index >= Inventory.instance.quickSlots.Length) return;

        selectedQuickSlotIndex = index;
        event_time = false;

        UpdateCurrentEquipment(); // ì„ íƒ ì§í›„ ì¥ë¹„ ê°±ì‹ 
    }


    private void TryDestroyNearestSpawnedObject()
    {
        if (objectSpawner == null || objectSpawner.spawnedObjects.Count == 0) return;

        GameObject closest = null;
        float minDist = 1.5f;

        for (int i = objectSpawner.spawnedObjects.Count - 1; i >= 0; i--)
        {
            GameObject obj = objectSpawner.spawnedObjects[i];

            // â˜… í•µì‹¬: ì´ë¯¸ íŒŒê´´ë˜ì—ˆëŠ”ì§€(nullì¸ì§€) ë¨¼ì € í™•ì¸
            if (obj == null)
            {
                objectSpawner.spawnedObjects.RemoveAt(i); // ë¦¬ìŠ¤íŠ¸ ì²­ì†Œ
                continue;
            }

            float dist = Vector3.Distance(transform.position, obj.transform.position);
            if (dist < minDist)
            {
                closest = obj;
                minDist = dist;
            }
        }

        // â˜… ì‹¤í–‰ ì§ì „ì— í•œ ë²ˆ ë” ì²´í¬
        if (closest != null)
        {
            objectSpawner.spawnedObjects.Remove(closest);
            Destroy(closest);
        }
    }
    private void OnCollisionEnter2D(Collision2D collision)
    {
        if (collision.gameObject.CompareTag("sea") || collision.gameObject.CompareTag("farmTile"))
        {
            collidedObject = collision.gameObject;
        }
    }
    private void OnCollisionExit2D(Collision2D collision)
    {
        if (collision.gameObject == collidedObject)
        {
            collidedObject = null;
            Debug.Log("ì¶©ëŒ ê°ì²´ í•´ì œë¨");
        }
    }


    private void UpdateCurrentEquipment()
    {
        if (Inventory.instance == null || Inventory.instance.quickSlots == null) return;

        // ì¸ë±ìŠ¤ ë²”ìœ„ ì´ˆê³¼ ë°©ì§€
        if (selectedQuickSlotIndex >= Inventory.instance.quickSlots.Length) return;

        Item selectedItem = Inventory.instance.quickSlots[selectedQuickSlotIndex];

        if (selectedItem != null && selectedItem.data != null)
        {
            // â˜… ì£¼ì˜: CSVì˜ itemIDê°€ ê¸°ì¡´ ì¡°ê±´ë¬¸("Hoe", "Seeds", "Water" ë“±)ê³¼ ì •í™•íˆ ì¼ì¹˜í•´ì•¼ í•©ë‹ˆë‹¤.
            currentEquipment = selectedItem.data.itemID;
            Debug.Log($"[í€µìŠ¬ë¡¯ {selectedQuickSlotIndex + 1}ë²ˆ] ì¥ì°©ë¨: {currentEquipment}");
        }
        else
        {
            currentEquipment = ""; // ë¹ˆ ì¹¸ì´ë©´ ì¥ë¹„ í•´ì œ
            Debug.Log($"[í€µìŠ¬ë¡¯ {selectedQuickSlotIndex + 1}ë²ˆ] ë¹„ì–´ìˆìŒ");
        }
    }


}
